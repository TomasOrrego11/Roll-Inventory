{% extends "base.html" %}
{% set title = "Edit / Move Roll" %}
{% block content %}
<a class="btn inline" href="{{ url_for('home') }}">Back</a>

<h3>Edit Roll: {{ roll.roll_id }}</h3>

<form method="post" autocomplete="off">
  <label>PaperType</label>
  <input name="paper_type" value="{{ roll.paper_type }}" required>

  <label>Weight (lbs, integer)</label>
  <input name="weight_lbs" value="{{ roll.weight_lbs }}" inputmode="numeric" required>

  <label>Warehouse</label>
  <select name="warehouse" id="warehouse" required>
    {% for w in warehouses %}
      <option value="{{ w }}" {% if roll.warehouse == w %}selected{% endif %}>{{ w }}</option>
    {% endfor %}
  </select>

  <label>Sublocation (required for WH1/WH2, empty for CONSUMED/USED)</label>

  <select name="sublocation" id="sublocation">
    <!-- populated by JS -->
  </select>

  <button class="btn" type="submit">Save Changes</button>
</form>

<script>
  const wh1 = {{ wh1_sublocs|tojson }};
  const wh2 = {{ wh2_sublocs|tojson }};
  const currentWH = "{{ roll.warehouse }}";
  const currentSub = "{{ roll.sublocation }}";

  const whEl = document.getElementById("warehouse");
  const subEl = document.getElementById("sublocation");

  function fillSublocs(wh) {
    subEl.innerHTML = "";
    if (wh === "WH1") {
      addOptions(wh1, currentSub);
    } else if (wh === "WH2") {
      addOptions(wh2, currentSub);
    } else {
      // CONSUMED / USED => empty only
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "(none)";
      subEl.appendChild(opt);
      subEl.value = "";
    }
  }

  function addOptions(list, selected) {
    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = "Select sublocation";
    subEl.appendChild(placeholder);

    list.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      if (v === selected) opt.selected = true;
      subEl.appendChild(opt);
    });

    // If current subloc isn't in list, default to placeholder
    if (!list.includes(selected)) subEl.value = "";
  }

  whEl.addEventListener("change", () => {
    // when user switches WH, reset selection
    fillSublocs(whEl.value);
  });

  // initial
  fillSublocs(currentWH);
</script>
{% endblock %}
